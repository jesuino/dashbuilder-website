<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Integration :: Documentation</title>
    <link rel="canonical" href="https://www.optaplanner.org/docs/optaplanner/latest/integration/integration.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
<link rel="stylesheet" href="../../../_/css/menu.css"><!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 1/2 -->
<script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
<!-- Google Analytics for kie team: Global site tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-39485370-1"></script>
<script>
    window.dataLayer=window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments)
    };
    gtag('js',new Date());
    gtag('config','UA-39485370-1')
</script>
<script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="../../../_/../../">
          <img src="../../../_/img/optaPlannerLogoDarkBackground200px.png" alt="OptaPlanner logo"/>
        </a>
        <a class="navbar-item" href="https://www.optaplanner.org/docs">Documentation</a>
      </div>
      <div class="navbar-item hide-for-print">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://docs.optaplanner.org">Archive</a>
        <div class="navbar-item">
          <a class="navbar-item small-item" href="https://github.com/kiegroup/kie-tools" title="Follow KIE Tools on GitHub"><div class="github-icon"></div></a>
          <a class="navbar-item small-item" href="https://mobile.twitter.com/dashbuilder" target="_blank" title="Follow DashBuilder on Twitter"><img alt="T" src="../../../_/img/twitterLogo.png"></a>
          <a class="navbar-item small-item" href="https://www.youtube.com/channel/UCZvoXHoI4HIbKf9i-JO2jYA" target="_blank" title="DashBuilder YouTube channel"><img alt="YT" src="../../../_/img/youtubeLogo.png" style="height: 16px"></a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="optaplanner" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OptaPlanner User Guide 8.16.1.Final</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../planner-introduction/planner-introduction.html">OptaPlanner Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Quickstart</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/overview/overview-quickstarts.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/hello-world/hello-world-quickstart.html">Hello world Java quick start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/quarkus/quarkus-quickstart.html">Quarkus Java quick start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/spring-boot/spring-boot-quickstart.html">Spring Boot Java quick start</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../use-cases-and-examples/use-cases-and-examples.html">Use cases and examples</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../planner-configuration/planner-configuration.html">OptaPlanner configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../score-calculation/score-calculation.html">Score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../constraint-streams/constraint-streams.html">Constraint streams score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../drools-score-calculation/drools-score-calculation.html">Drools score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../shadow-variable/shadow-variable.html">Shadow variable</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../optimization-algorithms/optimization-algorithms.html">Optimization algorithms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../move-and-neighborhood-selection/move-and-neighborhood-selection.html">Move and neighborhood selection</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../exhaustive-search/exhaustive-search.html">Exhaustive search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../construction-heuristics/construction-heuristics.html">Construction heuristics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../local-search/local-search.html">Local search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../evolutionary-algorithms/evolutionary-algorithms.html">Evolutionary algorithms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../hyperheuristics/hyperheuristic.html">Hyperheuristics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../partitioned-search/partitioned-search.html">Partitioned search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../benchmarking-and-tweaking/benchmarking-and-tweaking.html">Benchmarking and tweaking</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../repeated-planning/repeated-planning.html">Repeated planning</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="integration.html">Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../design-patterns/design-patterns.html">Design patterns</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../development/development.html">Development</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OptaPlanner User Guide 8.16.1.Final</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OptaPlanner User Guide 8.16.1.Final</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../planner-introduction/planner-introduction.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OptaPlanner User Guide 8.16.1.Final</a></li>
    <li><a href="integration.html">Integration</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/kiegroup/optaplanner/edit/main/optaplanner-docs/src/modules/ROOT/pages/integration/integration.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Integration</h1>
<div class="sect1">
<h2 id="integrationOverview"><a class="anchor" href="#integrationOverview"></a>1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OptaPlanner&#8217;s input and output data (the planning problem and the best solution) are plain old JavaBeans (POJOs), so integration with other Java technologies is straightforward.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To read a planning problem from the database (and store the best solution in it), annotate the domain POJOs with JPA annotations.</p>
</li>
<li>
<p>To read a planning problem from an XML file (and store the best solution in it), annotate the domain POJOs with XStream or JAXB annotations.</p>
</li>
<li>
<p>To expose the Solver as a REST Service that reads the planning problem and responds with the best solution, annotate the domain POJOs with XStream, JAXB or Jackson annotations and hook the <code>Solver</code> in Camel or RESTEasy.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/integration/integrationOverview.png" alt="integrationOverview">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrationWithPersistentStorage"><a class="anchor" href="#integrationWithPersistentStorage"></a>2. Persistent storage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="integrationWithJpaAndHibernate"><a class="anchor" href="#integrationWithJpaAndHibernate"></a>2.1. Database: JPA and Hibernate</h3>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with JPA annotations
to store them in a database by calling <code>EntityManager.persist()</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not confuse JPA&#8217;s <code>@Entity</code> annotation with OptaPlanner&#8217;s <code>@PlanningEntity</code> annotation.
They can appear both on the same class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningEntity // OptaPlanner annotation
@Entity // JPA annotation
public class Talk {...}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jpa</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect3">
<h4 id="jpaAndHibernatePersistingAScore"><a class="anchor" href="#jpaAndHibernatePersistingAScore"></a>2.1.1. JPA and Hibernate: persisting a <code>Score</code></h4>
<div class="paragraph">
<p>When a <code>Score</code> is persisted into a relational database, JPA and Hibernate will default to Java serializing it to a <code>BLOB</code> column.
This has several disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Java serialization format of <code>Score</code> classes is currently not backwards compatible. Upgrading to a newer OptaPlanner version can break reading an existing database.</p>
</li>
<li>
<p>The score is not easily readable for a query executed in the database console. This is annoying during development.</p>
</li>
<li>
<p>The score cannot be used in a SQL or JPA-QL query to efficiently filter the results: for example to query all infeasible schedules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To avoid these issues, configure it to instead use INTEGER (or other) columns, by using the appropriate <code>*ScoreHibernateType</code> for your <code>Score</code> type, for example for a <code>HardSoftScore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
@Entity
@TypeDef(defaultForType = HardSoftScore.class, typeClass = HardSoftScoreHibernateType.class)
public class CloudBalance {

    @PlanningScore
    @Columns(columns = {@Column(name = "initScore"), @Column(name = "hardScore"), @Column(name = "softScore")})
    protected HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Configure the same number of <code>@Column</code> annotations as the number of score levels in the score plus one (for the <code>initScore</code>), otherwise Hibernate will fail fast because a property mapping has the wrong number of columns.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this case, the DDL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE CloudBalance(
    ...
    initScore INTEGER,
    hardScore INTEGER,
    softScore INTEGER
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a <code>BigDecimal</code> based <code>Score</code>, specify the precision and scale of the columns to avoid silent rounding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
@Entity
@TypeDef(defaultForType = HardSoftBigDecimalScore.class, typeClass = HardSoftBigDecimalScoreHibernateType.class)
public class CloudBalance{

    @PlanningScore
    @Columns(columns = {
            @Column(name = "initScore")
            @Column(name = "hardScore", precision = 10, scale = 5),
            @Column(name = "softScore", precision = 10, scale = 5)})
    protected HardSoftBigDecimalScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the DDL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE CloudBalance(
    ...
    initScore INTEGER,
    hardScore DECIMAL(10, 5),
    softScore DECIMAL(10, 5)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using any type of bendable <code>Score</code>, specify the hard and soft level sizes as parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
@Entity
@TypeDef(defaultForType = BendableScore.class, typeClass = BendableScoreHibernateType.class, parameters = {
        @Parameter(name = "hardLevelsSize", value = "3"),
        @Parameter(name = "softLevelsSize", value = "2")})
public class Schedule {

    @PlanningScore
    @Columns(columns = {
            @Column(name = "initScore")
            @Column(name = "hard0Score"),
            @Column(name = "hard1Score"),
            @Column(name = "hard2Score"),
            @Column(name = "soft0Score"),
            @Column(name = "soft1Score")})
    protected BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All this support is Hibernate specific because currently JPA 2.1&#8217;s converters do not support converting to multiple columns.</p>
</div>
</div>
<div class="sect3">
<h4 id="jpaAndHibernatePlanningCloning"><a class="anchor" href="#jpaAndHibernatePlanningCloning"></a>2.1.2. JPA and Hibernate: planning cloning</h4>
<div class="paragraph">
<p>In JPA and Hibernate, there is usually a <code>@ManyToOne</code> relationship from most problem fact classes to the planning solution class.
Therefore, the problem fact classes reference the planning solution class, which implies that when the solution is <a href="../planner-configuration/planner-configuration.html#cloningASolution" class="page">planning cloned</a>, they need to be cloned too.
Use an <code>@DeepPlanningClone</code> on each such problem fact class to enforce that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution // OptaPlanner annotation
@Entity // JPA annotation
public class Conference {

    @OneToMany(mappedBy="conference")
    private List&lt;Room&gt; roomList;

    ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@DeepPlanningClone // OptaPlanner annotation: Force the default planning cloner to planning clone this class too
@Entity // JPA annotation
public class Room {

    @ManyToOne
    private Conference conference; // Because of this reference, this problem fact needs to be planning cloned too

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Neglecting to do this can lead to persisting duplicate solutions, JPA exceptions or other side effects.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithXStream"><a class="anchor" href="#integrationWithXStream"></a>2.2. XML or JSON: XStream</h3>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with XStream annotations to serialize them to/from XML or JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-xstream</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect3">
<h4 id="xStreamMarshallingAScore"><a class="anchor" href="#xStreamMarshallingAScore"></a>2.2.1. XStream: marshalling a <code>Score</code></h4>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to XML or JSON by the default XStream configuration, it&#8217;s verbose and ugly.
To fix that, configure the appropriate <code>ScoreXStreamConverter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
@XStreamAlias("CloudBalance")
public class CloudBalance {

    @PlanningScore
    @XStreamConverter(HardSoftScoreXStreamConverter.class)
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates pretty XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;CloudBalance&gt;
   ...
   &lt;score&gt;0hard/-200soft&lt;/score&gt;
&lt;/CloudBalance&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
@XStreamAlias("Schedule")
public class Schedule {

    @PlanningScore
    @XStreamConverter(BendableScoreXStreamConverter.class)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;Schedule&gt;
   ...
   &lt;score&gt;[0/0]hard/[-100/-20/-3]soft&lt;/score&gt;
&lt;/Schedule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When reading a bendable score from an XML element, the implied <code>hardLevelsSize</code> and <code>softLevelsSize</code>
must always be in sync with those in the solver.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithJaxb"><a class="anchor" href="#integrationWithJaxb"></a>2.3. XML or JSON: JAXB</h3>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with JAXB annotations to serialize them to/from XML or JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jaxb</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect3">
<h4 id="jaxbMarshallingAScore"><a class="anchor" href="#jaxbMarshallingAScore"></a>2.3.1. JAXB: marshalling a <code>Score</code></h4>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to XML or JSON by the default JAXB configuration, it&#8217;s corrupted.
To fix that, configure the appropriate <code>ScoreJaxbAdapter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
@XmlRootElement @XmlAccessorType(XmlAccessType.FIELD)
public class CloudBalance {

    @PlanningScore
    @XmlJavaTypeAdapter(HardSoftScoreJaxbAdapter.class)
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates pretty XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;cloudBalance&gt;
   ...
   &lt;score&gt;0hard/-200soft&lt;/score&gt;
&lt;/cloudBalance&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
@XmlRootElement @XmlAccessorType(XmlAccessType.FIELD)
public class Schedule {

    @PlanningScore
    @XmlJavaTypeAdapter(BendableScoreJaxbAdapter.class)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, with a <code>hardLevelsSize</code> of <code>2</code> and a <code>softLevelsSize</code> of <code>3</code>, that will generate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;schedule&gt;
   ...
   &lt;score&gt;[0/0]hard/[-100/-20/-3]soft&lt;/score&gt;
&lt;/schedule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hardLevelsSize</code> and <code>softLevelsSize</code> implied, when reading a bendable score from an XML element, must always be in sync with those in the solver.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithJackson"><a class="anchor" href="#integrationWithJackson"></a>2.4. JSON: Jackson</h3>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with Jackson annotations to serialize them to/from JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jackson</code> jar and register <code>OptaPlannerJacksonModule</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ObjectMapper objectMapper = new ObjectMapper();
objectMapper.registerModule(OptaPlannerJacksonModule.createModule());</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="jacksonMarshallingAScore"><a class="anchor" href="#jacksonMarshallingAScore"></a>2.4.1. Jackson: marshalling a <code>Score</code></h4>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to/from JSON by the default Jackson configuration, it fails.
The <code>OptaPlannerJacksonModule</code> fixes that, by using <code>HardSoftScoreJacksonSerializer</code>,
<code>HardSoftScoreJacksonDeserializer</code>, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
   "score":"0hard/-200soft"
   ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When reading a <code>BendableScore</code>, the <code>hardLevelsSize</code> and <code>softLevelsSize</code> implied in the JSON element,
must always be in sync with those defined in the <code>@PlanningScore</code> annotation in the solution class.For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
   "score":"[0/0]hard/[-100/-20/-3]soft"
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This JSON implies the <code>hardLevelsSize</code> is 2 and the <code>softLevelsSize</code> is 3,
which must be in sync with the <code>@PlanningScore</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
public class Schedule {

    @PlanningScore(bendableHardLevelsSize = 2, bendableSoftLevelsSize = 3)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a field is the <code>Score</code> supertype (instead of a specific type such as <code>HardSoftScore</code>), it uses <code>PolymorphicScoreJacksonSerializer</code> and <code>PolymorphicScoreJacksonDeserializer</code>
to record the score type in JSON too, otherwise it would be impossible to deserialize it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private Score score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
   "score":{"HardSoftScore":"0hard/-200soft"}
   ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithJsonb"><a class="anchor" href="#integrationWithJsonb"></a>2.5. JSON: JSON-B</h3>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with JSON-B annotations to serialize them to/from JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jsonb</code> jar and use <code>OptaPlannerJsonbConfig</code> to create a <code>Jsonb</code> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">JsonbConfig config = OptaPlannerJsonbConfig.createConfig();
Jsonb jsonb = JsonbBuilder.create(config);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="jsonbMarshallingAScore"><a class="anchor" href="#jsonbMarshallingAScore"></a>2.5.1. JSON-B: marshalling a <code>Score</code></h4>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to/from JSON by the default JSON-B configuration, it fails.
The <code>OptaPlannerJsonbConfig</code> fixes that, by using adapters including <code>BendableScoreJsonbAdapter</code>, <code>HardSoftScoreJsonbAdapter</code>, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"hardSoftScore":"0hard/-200soft"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"bendableScore":"[0/0]hard/[-200/-20/0]soft"}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrationWithQuarkus"><a class="anchor" href="#integrationWithQuarkus"></a>3. Quarkus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use OptaPlanner with Quarkus, read the <a href="../quickstart/quarkus/quarkus-quickstart.html#quarkusJavaQuickStart" class="page">Quarkus Java quick start</a>.
If you are starting a new project, visit the <a href="https://code.quarkus.io/">code.quarkus.io</a> and select
the <em>OptaPlanner AI constraint solver</em> extension before generating your application.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DRL score calculation is currently incompatible with the <code>quarkus:dev</code> mode.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Following properties are supported in the Quarkus <code>application.properties</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">quarkus.optaplanner.solver-manager.parallel-solver-count</dt>
<dd>
<p>The number of solvers that run in parallel.
This directly influences CPU consumption.
Defaults to <code>AUTO</code>.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver-config-xml</dt>
<dd>
<p>A classpath resource to read the solver configuration XML.
Defaults to <code>solverConfig.xml</code>.
If this property isn&#8217;t specified, that file is optional.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.score-drl</dt>
<dd>
<p>A classpath resource to read the score DRL.
Defaults to <code>constraints.drl</code>.
Do not define this property when a <code>ConstraintProvider</code>, <code>EasyScoreCalculator</code> or <code>IncrementalScoreCalculator</code> class exists.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver.environment-mode</dt>
<dd>
<p>Enable runtime assertions to detect common bugs in your implementation during development.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver.daemon</dt>
<dd>
<p>Enable <a href="../repeated-planning/repeated-planning.html#daemon" class="page">daemon mode</a>.
In daemon mode, non-early termination pauses the solver instead of stopping it, until the next problem fact change arrives.
This is often useful for <a href="../repeated-planning/repeated-planning.html#realTimePlanning" class="page">real-time planning</a>.
Defaults to <code>false</code>.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver.move-thread-count</dt>
<dd>
<p>Enable multithreaded solving for a single problem, which increases CPU consumption.
Defaults to <code>NONE</code>.
See <a href="../optimization-algorithms/optimization-algorithms.html#multithreadedIncrementalSolving" class="page">multithreaded incremental solving</a>.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver.domain-access-type</dt>
<dd>
<p>How OptaPlanner should access the domain model.
See <a href="../planner-configuration/planner-configuration.html#domainAccess" class="page">the domain access section</a> for more details.
Defaults to <code>GIZMO</code>.
The other possible value is <code>REFLECTION</code>.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver.termination.spent-limit</dt>
<dd>
<p>How long the solver can run.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver.termination.unimproved-spent-limit</dt>
<dd>
<p>How long the solver can run without finding a new best solution after finding a new best solution.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.solver.termination.best-score-limit</dt>
<dd>
<p>Terminates the solver when a specific or higher score has been reached.
For example: <code>0hard/-1000soft</code> terminates when the best score changes from <code>0hard/-1200soft</code> to <code>0hard/-900soft</code>.
Wildcards are supported to replace numbers.
For example: <code>0hard/*soft</code> to terminate when any feasible score is reached.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.benchmark.solver-benchmark-config-xml</dt>
<dd>
<p>A classpath resource to read the benchmark configuration XML.
Defaults to solverBenchmarkConfig.xml.
If this property isn&#8217;t specified, that solverBenchmarkConfig.xml is optional.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.benchmark.result-directory</dt>
<dd>
<p>Where the benchmark results are written to. Defaults to
target/benchmarks.</p>
</dd>
<dt class="hdlist1">quarkus.optaplanner.benchmark.solver.termination.spent-limit</dt>
<dd>
<p>How long solver should be run in a benchmark run.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.
Also supports ISO-8601 format, see <a href="https://docs.oracle.com/javase/8/docs/api/java/time/Duration.html">Duration</a>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrationWithSpringBoot"><a class="anchor" href="#integrationWithSpringBoot"></a>4. Spring Boot</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use OptaPlanner on Spring Boot, add the <code>optaplanner-spring-boot-starter</code> dependency
and read the <a href="../quickstart/spring-boot/spring-boot-quickstart.html#springBootJavaQuickStart" class="page">Spring Boot Java quick start</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DRL score calculation is currently incompatible with the dependency <code>spring-boot-devtools</code>:
none of the DRL rules will fire, due to ClassLoader issues.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These properties are supported in Spring&#8217;s <code>application.properties</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">optaplanner.solver-manager.parallel-solver-count</dt>
<dd>
<p>The number of solvers that run in parallel.
This directly influences CPU consumption.
Defaults to <code>AUTO</code>.</p>
</dd>
<dt class="hdlist1">optaplanner.solver-config-xml</dt>
<dd>
<p>A classpath resource to read the solver configuration XML.
Defaults to <code>solverConfig.xml</code>.
If this property isn&#8217;t specified, that file is optional.</p>
</dd>
<dt class="hdlist1">optaplanner.score-drl</dt>
<dd>
<p>A classpath resource to read the score DRL.
Defaults to <code>constraints.drl</code>.
Do not define this property when a <code>ConstraintProvider</code>, <code>EasyScoreCalculator</code> or <code>IncrementalScoreCalculator</code> class exists.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.environment-mode</dt>
<dd>
<p>Enable runtime assertions to detect common bugs in your implementation during development.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.daemon</dt>
<dd>
<p>Enable <a href="../repeated-planning/repeated-planning.html#daemon" class="page">daemon mode</a>.
In daemon mode, non-early termination pauses the solver instead of stopping it, until the next problem fact change arrives.
This is often useful for <a href="../repeated-planning/repeated-planning.html#realTimePlanning" class="page">real-time planning</a>.
Defaults to <code>false</code>.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.move-thread-count</dt>
<dd>
<p>Enable multithreaded solving for a single problem, which increases CPU consumption.
Defaults to <code>NONE</code>.
See <a href="../optimization-algorithms/optimization-algorithms.html#multithreadedIncrementalSolving" class="page">multithreaded incremental solving</a>.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.domain-access-type</dt>
<dd>
<p>How OptaPlanner should access the domain model.
See <a href="../planner-configuration/planner-configuration.html#domainAccess" class="page">the domain access section</a> for more details.
Defaults to <code>REFLECTION</code>.
The other possible value is <code>GIZMO</code>.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.termination.spent-limit</dt>
<dd>
<p>How long the solver can run.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.termination.unimproved-spent-limit</dt>
<dd>
<p>How long the solver can run without finding a new best solution after finding a new best solution.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.termination.best-score-limit</dt>
<dd>
<p>Terminates the solver when a specific or higher score has been reached.
For example: <code>0hard/-1000soft</code> terminates when the best score changes from <code>0hard/-1200soft</code> to <code>0hard/-900soft</code>.
Wildcards are supported to replace numbers.
For example: <code>0hard/*soft</code> to terminate when any feasible score is reached.</p>
</dd>
<dt class="hdlist1">optaplanner.benchmark.solver-benchmark-config-xml</dt>
<dd>
<p>A classpath resource to read the benchmark configuration XML.
Defaults to solverBenchmarkConfig.xml.
If this property isn&#8217;t specified, that solverBenchmarkConfig.xml is optional.</p>
</dd>
<dt class="hdlist1">optaplanner.benchmark.result-directory</dt>
<dd>
<p>Where the benchmark results are written to. Defaults to
target/benchmarks.</p>
</dd>
<dt class="hdlist1">optaplanner.benchmark.solver.termination.spent-limit</dt>
<dd>
<p>How long solver should be run in a benchmark run.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.
Also supports ISO-8601 format, see <a href="https://docs.oracle.com/javase/8/docs/api/java/time/Duration.html">Duration</a>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrationWithSoaAndEsb"><a class="anchor" href="#integrationWithSoaAndEsb"></a>5. SOA and ESB</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="integrationWithCamel"><a class="anchor" href="#integrationWithCamel"></a>5.1. Camel and Karaf</h3>
<div class="paragraph">
<p><a href="http://camel.apache.org/">Camel</a> is an enterprise integration framework which includes support for OptaPlanner (starting from Camel 2.13). It can expose a use case as a REST service, a SOAP service, a JMS service, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><a href="http://camel.apache.org/optaplanner.html">Read the documentation for the camel-optaplanner component.</a>
That component works in Karaf too.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrationWithOtherEnvironments"><a class="anchor" href="#integrationWithOtherEnvironments"></a>6. Other environments</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="integrationWithJBossModules"><a class="anchor" href="#integrationWithJBossModules"></a>6.1. JBoss Modules, WildFly, and JBoss EAP</h3>
<div class="paragraph">
<p>Because of JBoss Modules' <code>ClassLoader</code> magic, provide the <code>ClassLoader</code> of your classes <a href="../planner-configuration/planner-configuration.html#solverConfigurationByXML" class="page">during the SolverFactory creation</a>,
so it can find the classpath resources (the solver config, domain classes, etc.) in your jars.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also recommended <a href="../optimization-algorithms/optimization-algorithms.html#customThreadFactory" class="page">to plug in WildFly&#8217;s thread factory</a>,
especially with <a href="../optimization-algorithms/optimization-algorithms.html#multithreadedSolving" class="page">multithreaded solving</a>.</p>
</div>
<div class="sect3">
<h4 id="loggingOnWildFlyAndJBossEAP"><a class="anchor" href="#loggingOnWildFlyAndJBossEAP"></a>6.1.1. Logging on WildFly and JBoss EAP</h4>
<div class="paragraph">
<p>To get decent <a href="../planner-configuration/planner-configuration.html#logging" class="page">logging of the solver(s)</a>, create a file <code>src/main/resources/jboss-log4j.xml</code>
(so it ends up in the <code>war</code> as <code>WEB-INF/classes/jboss-log4j.xml</code>) with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/" debug="false"&gt;

  &lt;appender name="consoleAppender" class="org.apache.log4j.ConsoleAppender"&gt;
    &lt;layout class="org.apache.log4j.PatternLayout"&gt;
      &lt;param name="ConversionPattern" value="%d{HH:mm:ss.SSS} %-5p [%t] %m%n"/&gt;
    &lt;/layout&gt;
  &lt;/appender&gt;

  &lt;logger name="org.optaplanner"&gt;
    &lt;level value="debug"/&gt;
  &lt;/logger&gt;

  &lt;root&gt;
    &lt;level value="warn" /&gt;
    &lt;appender-ref ref="consoleAppender"/&gt;
  &lt;/root&gt;

&lt;/log4j:configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="skinnyWarOnWildFlyAndJBossEAP"><a class="anchor" href="#skinnyWarOnWildFlyAndJBossEAP"></a>6.1.2. Skinny WAR on WildFly and JBoss EAP</h4>
<div class="paragraph">
<p>To deploy an OptaPlanner web application on WildFly, simply include the optaplanner dependency jars in the <code>war</code> file&#8217;s <code>WEB-INF/lib</code> directory
(just like any other dependency).
However, in this approach the war file can easily grow to several MB in size, which is fine for a one-time deployment,
but too heavyweight for frequent redeployments (especially over a slow network connection).</p>
</div>
<div class="paragraph">
<p>The remedy is to use deliver the optaplanner jars in a JBoss module to WildFly and create a skinny war.
Let&#8217;s create a module called <em>org.optaplanner</em>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the directory <code>${WILDFLY_HOME}/modules/system/layers/base/</code>. This directory contains the JBoss modules of WildFly. Create directory structure <code>org/optaplanner/main</code> for our new module.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy <code>optaplanner-core-${version}.jar</code> and all its direct and transitive dependency jars into that new directory. Use "mvn dependency:tree" on each optaplanner artifact to discover all dependencies.</p>
</li>
<li>
<p>Create the file <code>module.xml</code> in that new directory. Give it this content:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;module xmlns="urn:jboss:module:1.3" name="org.optaplanner"&gt;
  &lt;resources&gt;
    ...
    &lt;resource-root path="kie-api-${version}.jar"/&gt;
    ...
    &lt;resource-root path="optaplanner-core-${version}.jar"/&gt;
    ...
    &lt;resource-root path="."/&gt;
  &lt;/resources&gt;
  &lt;dependencies&gt;
    &lt;module name="javaee.api"/&gt;
  &lt;/dependencies&gt;
&lt;/module&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Navigate to the deployed <code>war</code> file.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove <code>optaplanner-core-${version}.jar</code> and all its direct and transitive dependency jars from the <code>WEB-INF/lib</code> directory in the <code>war</code> file.</p>
</li>
<li>
<p>Create the file <code>jboss-deployment-structure.xml</code> in the <code>WEB-INF/lib</code> directory. Give it this content:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;jboss-deployment-structure&gt;
   &lt;deployment&gt;
      &lt;dependencies&gt;
         &lt;module name="org.optaplanner" export="true"/&gt;
      &lt;/dependencies&gt;
   &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithJPMS"><a class="anchor" href="#integrationWithJPMS"></a>6.2. Java platform module system (Jigsaw)</h3>
<div class="paragraph">
<p>When using OptaPlanner from code on the modulepath (Java 9 and higher),
<em>open</em> your packages that contain your domain objects, constraints and solver configuration
<em>to all modules</em> in your <code>module-info.java</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">module org.optaplanner.cloudbalancing {
    requires org.optaplanner.core;
    ...

    opens org.optaplanner.examples.cloudbalancing; // Solver configuration
    opens org.optaplanner.examples.cloudbalancing.domain; // Domain classes
    opens org.optaplanner.examples.cloudbalancing.score; // Constraints
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise OptaPlanner can&#8217;t reach those classes or files, even if they are exported.</p>
</div>
<div class="paragraph">
<p>The package <code>org.xmlpull.v1</code> is split between dependencies of XStream.
A workaround is to patch the <code>xmlpull</code> module with the <code>xpp3_min-1.1.4c.jar</code> artifact.</p>
</div>
<div class="paragraph">
<p>Since OptaPlanner has no <code>module-info.java</code>, it is required to add its <code>java.scripting</code> dependency manually to the modulepath with this JVM argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">--add-modules java.scripting</code></pre>
</div>
</div>
<div class="paragraph">
<p>Drools and XStream require illegal reflective access to some internal Java packages. This can be achieved with the following JVM arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">--add-opens java.base/java.lang=org.drools.core \
--add-opens java.base/java.util=xstream \
--add-opens java.base/java.lang.reflect=xstream \
--add-opens java.base/java.text=xstream \
--add-opens java.desktop/java.awt.font=xstream</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithOSGi"><a class="anchor" href="#integrationWithOSGi"></a>6.3. OSGi</h3>
<div class="paragraph">
<p>The <code>optaplanner-core</code> jar includes OSGi metadata in its <code>MANIFEST.MF</code> file to function properly in an OSGi environment too.
Furthermore, the maven artifact <code>kie-karaf-features</code> contains a <code>features.xml</code> file that supports the OSGi-feature <code>optaplanner-engine</code>.</p>
</div>
<div class="paragraph">
<p>Because of the OSGi&#8217;s <code>ClassLoader</code> magic, provide the <code>ClassLoader</code> of your classes <a href="../planner-configuration/planner-configuration.html#solverConfigurationByXML" class="page">during the SolverFactory creation</a>,
so it can find the classpath resources (the solver config, domain classes, etc.) in your jars.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>OptaPlanner does <em>not</em> require OSGi.
It works perfectly fine in a normal Java environment too.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithAndroid"><a class="anchor" href="#integrationWithAndroid"></a>6.4. Android</h3>
<div class="paragraph">
<p>Android is not a complete JVM (because some JDK libraries are missing), but OptaPlanner works on Android with <a href="../score-calculation/score-calculation.html#easyJavaScoreCalculation" class="page">easy Java</a> or <a href="../score-calculation/score-calculation.html#incrementalJavaScoreCalculation" class="page">incremental Java</a> score calculation.
The Drools rule engine does not work on Android yet,
so <a href="../constraint-streams/constraint-streams.html#constraintStreams" class="page">Constraint Streams</a> and <a href="../drools-score-calculation/drools-score-calculation.html#droolsScoreCalculation" class="page">Drools score calculation</a> doesn&#8217;t work on Android and its dependencies need to be excluded.</p>
</div>
<div class="paragraph">
<p><strong>Workaround to use OptaPlanner on Android:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a dependency to the <code>build.gradle</code> file in your Android project to exclude <code>org.drools</code> and <code>xmlpull</code> dependencies:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">dependencies {
    ...
    compile('org.optaplanner:optaplanner-core:...') {
        exclude group: 'xmlpull'
        exclude group: 'org.drools'
    }
    ...
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrationWithHumanPlanners"><a class="anchor" href="#integrationWithHumanPlanners"></a>7. Integration with human planners (politics)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A good OptaPlanner implementation beats any good human planner for non-trivial datasets.
Many human planners fail to accept this, often because they feel threatened by an automated system.</p>
</div>
<div class="paragraph">
<p>But despite that, both can benefit if the human planner becomes the supervisor of OptaPlanner:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>The human planner defines, validates and tweaks the score function.</strong></p>
<div class="ulist">
<ul>
<li>
<p>The human planner tweaks the constraint weights of the <a href="../score-calculation/score-calculation.html#constraintConfiguration" class="page">constraint configuration</a> in a UI, as the business priorities change over time.</p>
</li>
<li>
<p>When the business changes, the score function often needs to change too.
The human planner can notify the developers to add, change or remove score constraints.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>The human planner is always in control of OptaPlanner.</strong></p>
<div class="ulist">
<ul>
<li>
<p>As shown in the course scheduling example, the human planner can pin down one or more planning variables to a specific planning value.
Because they are <a href="../repeated-planning/repeated-planning.html#pinnedPlanningEntities" class="page">pinned</a>, OptaPlanner does not change them: it optimizes the planning around the enforcements made by the human.
If the human planner pins down all planning variables, he/she sidelines OptaPlanner completely.</p>
</li>
<li>
<p>In a prototype implementation, the human planner occasionally uses pinning to intervene, but as the implementation matures, this should become obsolete.
The feature should be kept available as a reassurance for the humans, and in the event that the business changes dramatically before the score constraints are adjusted accordingly.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this reason, it is recommended that the human planner is actively involved in your project.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/integration/keepTheUserInControl.png" alt="keepTheUserInControl">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sizingHardwareAndSoftware"><a class="anchor" href="#sizingHardwareAndSoftware"></a>8. Sizing hardware and software</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before sizing a OptaPlanner service, first understand the typical behaviour of a <code>Solver.solve()</code> call:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../_images/integration/sizingHardware.png" alt="sizingHardware">
</div>
</div>
<div class="paragraph">
<p>Understand these guidelines to decide the hardware for a OptaPlanner service:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RAM memory</strong>: Provision plenty, but no need to provide more.</p>
<div class="ulist">
<ul>
<li>
<p>The problem dataset, loaded before OptaPlanner is called, often consumes the most memory. It depends on the problem scale.</p>
<div class="ulist">
<ul>
<li>
<p>For example, in the Machine Reassignment example some datasets use over 1GB in memory. But in most examples, they use just a few MB.</p>
</li>
<li>
<p>If this is a problem, review the domain class structure: remove classes or fields that OptaPlanner doesn&#8217;t need during solving.</p>
</li>
<li>
<p>OptaPlanner usually has up to three solution instances: the internal working solution, the best solution and the old best solution (when it&#8217;s being replaced). However, these are all a <a href="../planner-configuration/planner-configuration.html#cloningASolution" class="page">planning clone</a> of each other, so many problem fact instances are shared between those solution instances.</p>
</li>
</ul>
</div>
</li>
<li>
<p>During solving, the memory is very volatile, because solving creates many short-lived objects. The Garbage Collector deletes these in bulk and therefore needs some heap space as a buffer.</p>
</li>
<li>
<p>The maximum size of the JVM heap space can be in three states:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Insufficient</strong>: An <code>OutOfMemoryException</code> is thrown (often because the Garbage Collector is using more than 98% of the CPU time).</p>
</li>
<li>
<p><strong>Narrow</strong>: The heap buffer for those short-lived instances is too small, therefore the Garbage Collector needs to run more than it would like to, which causes a performance loss.</p>
<div class="ulist">
<ul>
<li>
<p>Profiling shows that in the heap chart, the used heap space frequently touches the max heap space during solving. It also shows that the Garbage Collector has a significant CPU usage impact.</p>
</li>
<li>
<p>Adding more heap space increases the <a href="../score-calculation/score-calculation.html#scoreCalculationSpeed" class="page">score calculation speed</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Plenty</strong>: There is enough heap space. The Garbage Collector is active, but its CPU usage is low.</p>
<div class="ulist">
<ul>
<li>
<p>Adding more heap space does <em>not</em> increase performance.</p>
</li>
<li>
<p>Usually, this is around 300 to 500MB above the dataset size, <em>regardless of the problem scale</em> (except with <a href="../move-and-neighborhood-selection/move-and-neighborhood-selection.html#nearbySelection" class="page">nearby selection</a> and caching move selector, neither are used by default).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>CPU power</strong>: More is better.</p>
<div class="ulist">
<ul>
<li>
<p>Improving CPU speed directly increases the <a href="../score-calculation/score-calculation.html#scoreCalculationSpeed" class="page">score calculation speed</a>.</p>
<div class="ulist">
<ul>
<li>
<p>If the CPU power is twice as fast, it takes half the time to find the same result. However, this does not guarantee that it finds a better result in the same time, nor that it finds a similar result for a problem twice as big in the same time.</p>
</li>
<li>
<p>Increasing CPU power usually does not resolve scaling issues, because planning problems scale exponentially. Power tweaking the solver configuration has far better results for scaling issues than throwing hardware at it.</p>
</li>
</ul>
</div>
</li>
<li>
<p>During the <code>solve()</code> method, the CPU power will max out until it returns (except in <a href="../repeated-planning/repeated-planning.html#daemon" class="page">daemon mode</a> or if your <a href="../optimization-algorithms/optimization-algorithms.html#SolverEventListener" class="page">SolverEventListener</a> writes the best solution to disk or the network).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Number of CPU cores</strong>: one CPU core per active Solver, plus at least one one for the operating system.</p>
<div class="ulist">
<ul>
<li>
<p>So in a multitenant application, which has one Solver per tenant, this means one CPU core per tenant, unless the number of solver threads is limited, as that limits the number of tenants being solved in parallel.</p>
</li>
<li>
<p>With Partitioned Search, presume one CPU core per partition (per active tenant), unless the number of partition threads is limited.</p>
<div class="ulist">
<ul>
<li>
<p>To reduce the number of used cores, it can be better to reduce the partition threads (so solve some partitions sequentially) than to reduce the number of partitions.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In use cases with many tenants (such as scheduling Software as a Service) or many partitions, it might not be affordable to provision that many CPUs.</p>
<div class="ulist">
<ul>
<li>
<p>Reduce the number of active Solvers at a time. For example: give each tenant only one minute of machine time and use a <code>ExecutorService</code> with a fixed thread pool to queue requests.</p>
</li>
<li>
<p>Distribute the Solver runs across the day (or night). This is especially an opportunity in SaaS that&#8217;s used across the globe, due to timezones: UK and India can use the same CPU core when scheduling at night.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The SolverManager will take care of the orchestration, especially in those underfunded environments in which solvers (and partitions) are forced to share CPU cores or wait in line.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>I/O (network, disk, &#8230;&#8203;)</strong>: Not used during solving.</p>
<div class="ulist">
<ul>
<li>
<p>OptaPlanner is not a web server: a solver thread does not block (unlike a servlet thread), each one fully drains a CPU.</p>
<div class="ulist">
<ul>
<li>
<p>A web server can handle 24 active servlets threads with eight cores without performance loss, because most servlets threads are blocking on I/O.</p>
</li>
<li>
<p>However, 24 active solver threads with eight cores will cause each solver&#8217;s <a href="../score-calculation/score-calculation.html#scoreCalculationSpeed" class="page">score calculation speed</a> to be three times slower, causing a big performance loss.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Note that calling any I/O during solving, for example a remote service in your score calculation, causes a huge performance loss because it&#8217;s called thousands of times per second, so it should complete in microseconds. So no good implementation does that.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep these guidelines in mind when selecting and configuring the software.
See <a href="https://www.optaplanner.org/blog/archive.html">our blog archive</a> for the details of our experiments, which use our diverse set of examples.
Your mileage may vary.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operating System</p>
<div class="ulist">
<ul>
<li>
<p>No experimentally proven advice yet (but prefer Linux anyway).</p>
</li>
</ul>
</div>
</li>
<li>
<p>JDK</p>
<div class="ulist">
<ul>
<li>
<p>Version: Our benchmarks have consistently shown improvements in performance when comparing new JDK releases with their predecessors. It is therefore recommended using the latest available JDK. If you&#8217;re interested in the performance comparisons of OptaPlanner running of different JDK releases, you can find them in the form of blog posts in <a href="https://www.optaplanner.org/blog/archive.html">our blog archive</a>.</p>
</li>
<li>
<p>Garbage Collector: ParallelGC can be potentially between 5% and 35% faster than G1GC (the default). Unlike web servers, OptaPlanner needs a GC focused on throughput, not latency. Use <code>-XX:+UseParallelGC</code> to turn on ParallelGC.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Logging can have a severe impact on performance.</p>
<div class="ulist">
<ul>
<li>
<p>Debug logging <code>org.drools</code> can reduce performance by a factor of 7.</p>
</li>
<li>
<p>Debug logging <code>org.optaplanner</code> can be between 0% and 15% slower than info logging. Trace logging can be between 5% and 70% slower than info logging.</p>
</li>
<li>
<p>Synchronous logging to a file has an additional significant impact for debug and trace logging (but not for info logging).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Avoid a cloud environment in which you share your CPU core(s) with other virtual machines or containers. Performance (and therefore solution quality) can be unreliable when the available CPU power varies greatly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep in mind that the perfect hardware/software environment will probably <em>not</em> solve scaling issues (even Moore&#8217;s law is too slow).
There is no need to follow these guidelines to the letter.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/lunr-2.3.9.min.js"></script>
<script src="../../../_/js/vendor/search.js" id="search-script" data-base-path="../../.." data-page-path="/optaplanner/latest/integration/integration.html"></script>
<script async src="../../../_/../search-index.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>

<!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 2/2 -->
<script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
</script>  </body>
</html>
