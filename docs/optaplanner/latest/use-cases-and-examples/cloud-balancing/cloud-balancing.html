<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cloud balancing :: Documentation</title>
    <link rel="canonical" href="https://www.optaplanner.org/docs/optaplanner/latest/use-cases-and-examples/cloud-balancing/cloud-balancing.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="stylesheet" href="../../../../_/css/menu.css"><!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 1/2 -->
<script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
<!-- Google Analytics for kie team: Global site tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-39485370-1"></script>
<script>
    window.dataLayer=window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments)
    };
    gtag('js',new Date());
    gtag('config','UA-39485370-1')
</script>
<script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="../../../../_/../../">
          <img src="../../../../_/img/optaPlannerLogoDarkBackground200px.png" alt="OptaPlanner logo"/>
        </a>
        <a class="navbar-item" href="https://www.optaplanner.org/docs">Documentation</a>
      </div>
      <div class="navbar-item hide-for-print">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://docs.optaplanner.org">Archive</a>
        <div class="navbar-item">
          <a class="navbar-item small-item" href="https://github.com/kiegroup/kie-tools" title="Follow KIE Tools on GitHub"><div class="github-icon"></div></a>
          <a class="navbar-item small-item" href="https://mobile.twitter.com/dashbuilder" target="_blank" title="Follow DashBuilder on Twitter"><img alt="T" src="../../../../_/img/twitterLogo.png"></a>
          <a class="navbar-item small-item" href="https://www.youtube.com/channel/UCZvoXHoI4HIbKf9i-JO2jYA" target="_blank" title="DashBuilder YouTube channel"><img alt="YT" src="../../../../_/img/youtubeLogo.png" style="height: 16px"></a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="optaplanner" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">OptaPlanner User Guide 8.16.1.Final</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../planner-introduction/planner-introduction.html">OptaPlanner Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Quickstart</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../quickstart/overview/overview-quickstarts.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../quickstart/hello-world/hello-world-quickstart.html">Hello world Java quick start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../quickstart/quarkus/quarkus-quickstart.html">Quarkus Java quick start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../quickstart/spring-boot/spring-boot-quickstart.html">Spring Boot Java quick start</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../use-cases-and-examples.html">Use cases and examples</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../planner-configuration/planner-configuration.html">OptaPlanner configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../score-calculation/score-calculation.html">Score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../constraint-streams/constraint-streams.html">Constraint streams score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../drools-score-calculation/drools-score-calculation.html">Drools score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../shadow-variable/shadow-variable.html">Shadow variable</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../optimization-algorithms/optimization-algorithms.html">Optimization algorithms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../move-and-neighborhood-selection/move-and-neighborhood-selection.html">Move and neighborhood selection</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../exhaustive-search/exhaustive-search.html">Exhaustive search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../construction-heuristics/construction-heuristics.html">Construction heuristics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../local-search/local-search.html">Local search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../evolutionary-algorithms/evolutionary-algorithms.html">Evolutionary algorithms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../hyperheuristics/hyperheuristic.html">Hyperheuristics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../partitioned-search/partitioned-search.html">Partitioned search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../benchmarking-and-tweaking/benchmarking-and-tweaking.html">Benchmarking and tweaking</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../repeated-planning/repeated-planning.html">Repeated planning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../integration/integration.html">Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../design-patterns/design-patterns.html">Design patterns</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../development/development.html">Development</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OptaPlanner User Guide 8.16.1.Final</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../index.html">OptaPlanner User Guide 8.16.1.Final</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../planner-introduction/planner-introduction.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">OptaPlanner User Guide 8.16.1.Final</a></li>
    <li><a href="cloud-balancing.html">Cloud balancing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/kiegroup/optaplanner/edit/main/optaplanner-docs/src/modules/ROOT/pages/use-cases-and-examples/cloud-balancing/cloud-balancing.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Cloud balancing</h1>
<div class="sect1">
<h2 id="cloudBalancingTutorial"><a class="anchor" href="#cloudBalancingTutorial"></a>Cloud balancing tutorial</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="cloudBalancingProblemDescription"><a class="anchor" href="#cloudBalancingProblemDescription"></a>Problem description</h3>
<div class="paragraph">
<p>Suppose your company owns a number of cloud computers and needs to run a number of processes on those computers.
Assign each process to a computer.</p>
</div>
<div class="paragraph">
<p>The following hard constraints must be fulfilled:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every computer must be able to handle the minimum hardware requirements of the sum of its processes:</p>
<div class="ulist">
<ul>
<li>
<p><strong>CPU capacity</strong>: The CPU power of a computer must be at least the sum of the CPU power required by the processes assigned to that computer.</p>
</li>
<li>
<p><strong>Memory capacity</strong>: The RAM memory of a computer must be at least the sum of the RAM memory required by the processes assigned to that computer.</p>
</li>
<li>
<p><strong>Network capacity</strong>: The network bandwidth of a computer must be at least the sum of the network bandwidth required by the processes assigned to that computer.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following soft constraints should be optimized:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each computer that has one or more processes assigned, incurs a maintenance cost (which is fixed per computer).</p>
<div class="ulist">
<ul>
<li>
<p><strong>Cost</strong>: Minimize the total maintenance cost.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This problem is a form of <em>bin packing</em>.
The following is a simplified example, in which we assign four processes to two computers with two constraints (CPU and RAM) with a simple algorithm:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/use-cases-and-examples/cloud-balancing/cloudBalanceUseCase.png" alt="cloudBalanceUseCase">
</div>
</div>
<div class="paragraph">
<p>The simple algorithm used here is the <em>First Fit Decreasing</em> algorithm, which assigns the bigger processes first and assigns the smaller processes to the remaining space.
As you can see, it is not optimal, as it does not leave enough room to assign the yellow process <code>D</code>.</p>
</div>
<div class="paragraph">
<p>OptaPlanner does find the more optimal solution by using additional, smarter algorithms.
It also scales: both in data (more processes, more computers) and constraints (more hardware requirements, other constraints).
So let&#8217;s see how OptaPlanner can be used in this scenario.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an executive summary of this example and <a href="../machine-reassignment/machine-reassignment.html#machineReassignment" class="page">an advanced implementation with more constraints</a>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/use-cases-and-examples/cloud-balancing/cloudOptimizationValueProposition.png" alt="cloudOptimizationValueProposition">
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingProblemSize"><a class="anchor" href="#cloudBalancingProblemSize"></a>Problem size</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Cloud Balancing Problem Size</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Problem Size</th>
<th class="tableblock halign-left valign-top">Computers</th>
<th class="tableblock halign-left valign-top">Processes</th>
<th class="tableblock halign-left valign-top">Search Space</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2computers-6processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3computers-9processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4computers-12processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100computers-300processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^600</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200computers-600processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">600</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^1380</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400computers-1200processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^3122</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">800computers-2400processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^6967</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloudBalancingDomainModel"><a class="anchor" href="#cloudBalancingDomainModel"></a>Using the domain model</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="cloudBalancingDomainModelDesign"><a class="anchor" href="#cloudBalancingDomainModelDesign"></a>Domain model design</h3>
<div class="paragraph">
<p>Using a <a href="../../design-patterns/design-patterns.html#domainModelingGuide" class="page">domain model</a> helps determine which classes are planning entities and which of their properties are planning variables. It also helps to simplify constraints, improve performance, and increase flexibility for future needs.</p>
</div>
<div class="paragraph">
<p>To create a domain model, define all the objects that represent the input data for the problem. In this simple example, the objects are processes and computers.</p>
</div>
<div class="paragraph">
<p>A separate object in the domain model must represent a full data set of problem, which contains the input data as well as a solution. In this example, this object holds a list of computers and a list of processes. Each process is assigned to a computer; the distribution of processes between computers is the solution.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Draw a class diagram of your domain model.</p>
</li>
<li>
<p>Normalize it to remove duplicate data.</p>
</li>
<li>
<p>Write down some sample instances for each class.</p>
<div class="ulist">
<ul>
<li>
<p><code>Computer</code>: represents a computer with certain hardware and maintenance costs.</p>
<div class="paragraph">
<p>In this example, the sample instances for the <code>Computer</code> class are: <code>cpuPower</code>, <code>memory</code>, <code>networkBandwidth</code>, <code>cost</code>.</p>
</div>
</li>
<li>
<p><code>Process</code>: represents a process with a demand. Needs to be assigned to a <code>Computer</code> by OptaPlanner.</p>
<div class="paragraph">
<p>Sample instances for <code>Process</code> are: <code>requiredCpuPower</code>, <code>requiredMemory</code>, and <code>requiredNetworkBandwidth</code>.</p>
</div>
</li>
<li>
<p><code>CloudBalance</code>: represents a problem. Contains every <code>Computer</code> and <code>Process</code> for a certain data set.</p>
<div class="paragraph">
<p>For an object representing the full data set and solution, a sample instance holding the <em>score</em> must be present. OptaPlanner can calculate and compare the scores for different solutions; the solution with the highest score is the optimal solution. Therefore, the sample instance for <code>CloudBalance</code> is <code>score</code>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Determine which relationships (or fields) change during planning.</p>
<div class="ulist">
<ul>
<li>
<p><em>Planning entity</em>: The class (or classes) that OptaPlanner can change during solving. In this example, it is the class <code>Process</code>, because OptaPlanner can assign processes to computers.</p>
</li>
<li>
<p><em>Problem fact</em>: A class representing input data that OptaPlanner cannot change.</p>
</li>
<li>
<p><em>Planning variable</em>: The property (or properties) of a planning entity class that changes during solving. In this example, it is the property <code>computer</code> on the class <code>Process</code>.</p>
</li>
<li>
<p><em>Planning solution</em>: The class that represents a solution to the problem. This class must represent the full data set and contain all planning entities. In this example that is the class <code>CloudBalance</code>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the UML class diagram below, the OptaPlanner concepts are already annotated:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/use-cases-and-examples/cloud-balancing/cloudBalanceClassDiagram.png" alt="cloudBalanceClassDiagram">
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingDomainModelImplementation"><a class="anchor" href="#cloudBalancingDomainModelImplementation"></a>Domain model implementation</h3>
<div class="sect3">
<h4 id="cloudBalancingClassComputer"><a class="anchor" href="#cloudBalancingClassComputer"></a>The <code>Computer</code> class</h4>
<div class="paragraph">
<p>The <code>Computer</code> class is a POJO (Plain Old Java Object). Usually, you will have more of this kind of classes with input data.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. CloudComputer.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class CloudComputer ... {

    private int cpuPower;
    private int memory;
    private int networkBandwidth;
    private int cost;

    ... // getters
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingClassProcess"><a class="anchor" href="#cloudBalancingClassProcess"></a>The <code>Process</code> class</h4>
<div class="paragraph">
<p>The <code>Process</code> class is particularly important. It is the class that is modified during solving.</p>
</div>
<div class="paragraph">
<p>We need to tell OptaPlanner that it can change the property <code>computer</code>. To do this:
. Annotate the class with <code>@PlanningEntity</code>.
. Annotate the getter <code>getComputer()</code> with <code>@PlanningVariable</code>.</p>
</div>
<div class="paragraph">
<p>Of course, the property <code>computer</code> needs a setter too, so OptaPlanner can change it during solving.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. CloudProcess.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningEntity(...)
public class CloudProcess ... {

    private int requiredCpuPower;
    private int requiredMemory;
    private int requiredNetworkBandwidth;

    private CloudComputer computer;

    ... // getters

    @PlanningVariable(valueRangeProviderRefs = {"computerRange"})
    public CloudComputer getComputer() {
        return computer;
    }

    public void setComputer(CloudComputer computer) {
        computer = computer;
    }

    // ************************************************************************
    // Complex methods
    // ************************************************************************

    ...

}</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>OptaPlanner needs to know which values it can choose from to assign to the property <code>computer</code>. Those values are retrieved from the method <code>CloudBalance.getComputerList()</code> on the planning solution, which returns a list of all computers in the current data set.</p>
</li>
<li>
<p>The <code>@PlanningVariable</code>'s <code>valueRangeProviderRefs</code> parameter on <code>CloudProcess.getComputer()</code> needs to match with the <code>@ValueRangeProvider</code>'s <code>id</code> on <code>CloudBalance.getComputerList()</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instead of getter annotations, it is also possible to use <a href="../../planner-configuration/planner-configuration.html#annotationAlternatives" class="page">field annotations</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingClassCloudBalance"><a class="anchor" href="#cloudBalancingClassCloudBalance"></a>The <code>CloudBalance</code> class</h4>
<div class="paragraph">
<p>The <code>CloudBalance</code> class has a <em class="path">@PlanningSolution</em> annotation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It holds a list of all computers and a list of all processes.</p>
</li>
<li>
<p>It represents both the planning problem and (if it is initialized) the planning solution.</p>
</li>
<li>
<p>To save a solution, OptaPlanner initializes a new instance of the class.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>processList</code> property holds a list of processes.
OptaPlanner can change the processes, allocating them to different computers.
Therefore, a process is a planning entity and the list of processes is a collection of planning entities.
We annotate the getter <code>getProcessList()</code> with <code>@PlanningEntityCollectionProperty</code>.</p>
</li>
<li>
<p>The <code>computerList</code> property holds a list of computers.
OptaPlanner cannot change the computers.
Therefore, a computer is a problem fact.
Especially for <a href="../../constraint-streams/constraint-streams.html#constraintStreams" class="page">Constraint Streams</a> and <a href="../../drools-score-calculation/drools-score-calculation.html#droolsScoreCalculation" class="page">Drools score calculation</a>,
the property <code>computerList</code> needs to be annotated with a <code>@ProblemFactCollectionProperty</code> so that OptaPlanner can retrieve the list of computers (problem facts) and make it available to the rule engine.</p>
</li>
<li>
<p>The <code>CloudBalance</code> class also has a <code>@PlanningScore</code> annotated property <code>score</code>, which is the <code>Score</code> of that solution in its current state.
OptaPlanner automatically updates it when it calculates a <code>Score</code> for a solution instance. Therefore, this property needs a setter.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 3. CloudBalance.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PlanningSolution
public class CloudBalance ... {

    private List&lt;CloudComputer&gt; computerList;

    private List&lt;CloudProcess&gt; processList;

    private HardSoftScore score;

    @ValueRangeProvider(id = "computerRange")
    @ProblemFactCollectionProperty
    public List&lt;CloudComputer&gt; getComputerList() {
        return computerList;
    }

    @PlanningEntityCollectionProperty
    public List&lt;CloudProcess&gt; getProcessList() {
        return processList;
    }

    @PlanningScore
    public HardSoftScore getScore() {
        return score;
    }

    public void setScore(HardSoftScore score) {
        this.score = score;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloudBalancingMainMethod"><a class="anchor" href="#cloudBalancingMainMethod"></a>Run the cloud balancing Hello World</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="../../planner-introduction/planner-introduction.html#runTheExamplesInAnIDE" class="page">Download and configure the examples in your preferred IDE.</a></p>
</li>
<li>
<p>Create a run configuration with the following main class: <code>org.optaplanner.examples.cloudbalancing.app.CloudBalancingHelloWorld</code></p>
<div class="paragraph">
<p>By default, the Cloud Balancing Hello World is configured to run for 120 seconds.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>It executes the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. CloudBalancingHelloWorld.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class CloudBalancingHelloWorld {

    public static void main(String[] args) {
        // Build the Solver
        SolverFactory&lt;CloudBalance&gt; solverFactory = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml");
        Solver&lt;CloudBalance&gt; solver = solverFactory.buildSolver();

        // Load a problem with 400 computers and 1200 processes
        CloudBalance unsolvedCloudBalance = new CloudBalancingGenerator().createCloudBalance(400, 1200);

        // Solve the problem
        CloudBalance solvedCloudBalance = solver.solve(unsolvedCloudBalance);

        // Display the result
        System.out.println("\nSolved cloudBalance with 400 computers and 1200 processes:\n"
                + toDisplayString(solvedCloudBalance));
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The code example does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the <code>Solver</code> based on a solver configuration
which can come from <a href="../../planner-configuration/planner-configuration.html#solverConfigurationByXML" class="page">an XML file</a> as classpath resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">        SolverFactory&lt;CloudBalance&gt; solverFactory = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml");
        Solver&lt;CloudBalance&gt; solver = solverFactory.buildSolver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or to avoid XML, build it through <a href="../../planner-configuration/planner-configuration.html#solverConfigurationByJavaAPI" class="page">the programmatic API</a> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">        SolverFactory&lt;CloudBalance&gt; solverFactory = SolverFactory.create(new SolverConfig()
                .withSolutionClass(CloudBalance.class)
                .withEntityClasses(CloudProcess.class)
                .withEasyScoreCalculatorClass(CloudBalancingEasyScoreCalculator.class)
                .withTerminationSpentLimit(Duration.ofMinutes(2)));
        Solver&lt;CloudBalance&gt; solver = solverFactory.buildSolver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The solver configuration is explained in <a href="#cloudBalancingSolverConfiguration">the next section</a>.</p>
</div>
</li>
<li>
<p>Load the problem.</p>
<div class="paragraph">
<p><code>CloudBalancingGenerator</code> generates a random problem: replace this with a class that loads a real problem, for example from a database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">        CloudBalance unsolvedCloudBalance = new CloudBalancingGenerator().createCloudBalance(400, 1200);</code></pre>
</div>
</div>
</li>
<li>
<p>Solve the problem.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">        CloudBalance solvedCloudBalance = solver.solve(unsolvedCloudBalance);</code></pre>
</div>
</div>
</li>
<li>
<p>Display the result.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">        System.out.println("\nSolved cloudBalance with 400 computers and 1200 processes:\n"
                + toDisplayString(solvedCloudBalance));</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloudBalancingSolverConfiguration"><a class="anchor" href="#cloudBalancingSolverConfiguration"></a>Solver configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The solver configuration file determines how the solving process works; it is considered a part of the code.
The file is named <code>cloudBalancingSolverConfig.xml</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. cloudBalancingSolverConfig.xml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;solver xmlns="https://www.optaplanner.org/xsd/solver" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="https://www.optaplanner.org/xsd/solver https://www.optaplanner.org/xsd/solver/solver.xsd"&gt;
  &lt;!-- Domain model configuration --&gt;
  &lt;solutionClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudBalance&lt;/solutionClass&gt;
  &lt;entityClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudProcess&lt;/entityClass&gt;

  &lt;!-- Score configuration --&gt;
  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;!--&lt;constraintProviderClass&gt;org.optaplanner.examples.cloudbalancing.score.CloudBalancingConstraintProvider&lt;/constraintProviderClass&gt;--&gt;
  &lt;/scoreDirectorFactory&gt;

  &lt;!-- Optimization algorithms configuration --&gt;
  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;30&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This solver configuration consists of three parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Domain model configuration</strong>: <em>What can OptaPlanner change?</em></p>
<div class="paragraph">
<p>We need to make OptaPlanner aware of our domain classes, annotated with <code>@PlanningEntity</code> and <code>@PlanningSolution</code> annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;solutionClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudBalance&lt;/solutionClass&gt;
  &lt;entityClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudProcess&lt;/entityClass&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Score configuration</strong>: <em>How should OptaPlanner optimize the planning variables?
What is our goal?</em></p>
<div class="paragraph">
<p>Since we have hard and soft constraints, we use a <code>HardSoftScore</code>.
But we need to tell OptaPlanner how to calculate the score, depending on our business requirements.
Further down, we will look into two alternatives to calculate the score, such as using an easy Java implementation, or Constraint Streams.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;!--&lt;constraintProviderClass&gt;org.optaplanner.examples.cloudbalancing.score.CloudBalancingConstraintProvider&lt;/constraintProviderClass&gt;--&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Optimization algorithms configuration</strong>: <em>How should OptaPlanner optimize it?</em></p>
<div class="paragraph">
<p>In this case, we use the default <a href="../../optimization-algorithms/optimization-algorithms.html#optimizationAlgorithms" class="page">optimization algorithms</a> (because no explicit optimization algorithms are configured) for 30 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;30&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>OptaPlanner should get a good result in seconds (and even in less than 15 milliseconds with
<a href="../../repeated-planning/repeated-planning.html#realTimePlanning" class="page">real-time planning</a>), but the more time it has, the better the results.
Advanced use cases might use different <a href="../../optimization-algorithms/optimization-algorithms.html#termination" class="page">termination criteria</a> than a hard time limit.</p>
</div>
<div class="paragraph">
<p>The default algorithms already easily surpass human planners and most in-house implementations.
Use the <a href="../../benchmarking-and-tweaking/benchmarking-and-tweaking.html#benchmarker" class="page">Benchmarker</a> to <a href="../../optimization-algorithms/optimization-algorithms.html#powerTweaking" class="page">power tweak</a> to get even better results.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloudBalancingScoreConfiguration"><a class="anchor" href="#cloudBalancingScoreConfiguration"></a>Score configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OptaPlanner searches for the solution with the highest <code>Score</code>.
This example uses a <code>HardSoftScore</code>, which means OptaPlanner looks for the solution with no hard constraints broken (fulfill hardware requirements) and as little as possible soft constraints broken (minimize maintenance cost).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../_images/use-cases-and-examples/cloud-balancing/scoreComparisonCloudBalancing.png" alt="scoreComparisonCloudBalancing">
</div>
</div>
<div class="paragraph">
<p>Of course, OptaPlanner needs to be told about these domain-specific score constraints.
There are several ways to implement such a score function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#cloudBalancingEasyJavaScoreConfiguration">Easy Java</a></p>
</li>
<li>
<p><a href="#cloudBalancingConstraintStreamsScoreConfiguration">Constraint Streams</a></p>
</li>
<li>
<p><a href="#cloudBalancingIncrementalJavaScoreConfiguration">Incremental Java</a></p>
</li>
<li>
<p><a href="#cloudBalancingDroolsScoreConfiguration">Drools</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cloudBalancingEasyJavaScoreConfiguration"><a class="anchor" href="#cloudBalancingEasyJavaScoreConfiguration"></a>Easy Java score configuration</h3>
<div class="paragraph">
<p>One way to define a score function is to implement the interface <code>EasyScoreCalculator</code> in plain Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just implement the <code>calculateScore(Solution)</code> method to return a <code>HardSoftScore</code> instance.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. CloudBalancingEasyScoreCalculator.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class CloudBalancingEasyScoreCalculator
    implements EasyScoreCalculator&lt;CloudBalance, HardSoftScore&gt; {

    /**
     * A very simple implementation. The double loop can easily be removed by using Maps as shown in
     * {@link CloudBalancingMapBasedEasyScoreCalculator#calculateScore(CloudBalance)}.
     */
    @Override
    public HardSoftScore calculateScore(CloudBalance cloudBalance) {
        int hardScore = 0;
        int softScore = 0;
        for (CloudComputer computer : cloudBalance.getComputerList()) {
            int cpuPowerUsage = 0;
            int memoryUsage = 0;
            int networkBandwidthUsage = 0;
            boolean used = false;

            // Calculate usage
            for (CloudProcess process : cloudBalance.getProcessList()) {
                if (computer.equals(process.getComputer())) {
                    cpuPowerUsage += process.getRequiredCpuPower();
                    memoryUsage += process.getRequiredMemory();
                    networkBandwidthUsage += process.getRequiredNetworkBandwidth();
                    used = true;
                }
            }

            // Hard constraints
            int cpuPowerAvailable = computer.getCpuPower() - cpuPowerUsage;
            if (cpuPowerAvailable &lt; 0) {
                hardScore += cpuPowerAvailable;
            }
            int memoryAvailable = computer.getMemory() - memoryUsage;
            if (memoryAvailable &lt; 0) {
                hardScore += memoryAvailable;
            }
            int networkBandwidthAvailable = computer.getNetworkBandwidth() - networkBandwidthUsage;
            if (networkBandwidthAvailable &lt; 0) {
                hardScore += networkBandwidthAvailable;
            }

            // Soft constraints
            if (used) {
                softScore -= computer.getCost();
            }
        }
        return HardSoftScore.of(hardScore, softScore);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even if we optimize the code above to use <code>Map</code>s to iterate through the <code>processList</code> only once, <em>it is still slow</em> because it does not do <a href="../../score-calculation/score-calculation.html#incrementalScoreCalculation" class="page">incremental score calculation</a>.
To fix that, either use constraint streams, incremental Java score calculation or Drools score calculation.</p>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingConstraintStreamsScoreConfiguration"><a class="anchor" href="#cloudBalancingConstraintStreamsScoreConfiguration"></a>Drools score configuration</h3>
<div class="paragraph">
<p>Constraint Streams use incremental calculation.
To use it, implement the interface <code>ConstraintProvider</code> in Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;constraintProviderClass&gt;org.optaplanner.examples.cloudbalancing.score.CloudBalancingConstraintProvider&lt;/constraintProviderClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to make sure that all computers have enough CPU, RAM and network bandwidth to support all their processes, so we make these hard constraints.
If those constraints are met, we want to minimize the maintenance cost, so we add that as a soft constraint.</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. CloudBalancingConstraintProvider.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class CloudBalancingConstraintProvider implements ConstraintProvider {

    @Override
    public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {
        return new Constraint[] {
                requiredCpuPowerTotal(constraintFactory),
                requiredMemoryTotal(constraintFactory),
                requiredNetworkBandwidthTotal(constraintFactory),
                computerCost(constraintFactory)
        };
    }

    Constraint requiredCpuPowerTotal(ConstraintFactory constraintFactory) {
        return constraintFactory.forEach(CloudProcess.class)
                .groupBy(CloudProcess::getComputer, sum(CloudProcess::getRequiredCpuPower))
                .filter((computer, requiredCpuPower) -&gt; requiredCpuPower &gt; computer.getCpuPower())
                .penalize("requiredCpuPowerTotal",
                        HardSoftScore.ONE_HARD,
                        (computer, requiredCpuPower) -&gt; requiredCpuPower - computer.getCpuPower());
    }

    Constraint requiredMemoryTotal(ConstraintFactory constraintFactory) {
        return constraintFactory.forEach(CloudProcess.class)
                .groupBy(CloudProcess::getComputer, sum(CloudProcess::getRequiredMemory))
                .filter((computer, requiredMemory) -&gt; requiredMemory &gt; computer.getMemory())
                .penalize("requiredMemoryTotal",
                        HardSoftScore.ONE_HARD,
                        (computer, requiredMemory) -&gt; requiredMemory - computer.getMemory());
    }

    Constraint requiredNetworkBandwidthTotal(ConstraintFactory constraintFactory) {
        return constraintFactory.forEach(CloudProcess.class)
                .groupBy(CloudProcess::getComputer, sum(CloudProcess::getRequiredNetworkBandwidth))
                .filter((computer, requiredNetworkBandwidth) -&gt; requiredNetworkBandwidth &gt; computer.getNetworkBandwidth())
                .penalize("requiredNetworkBandwidthTotal",
                        HardSoftScore.ONE_HARD,
                        (computer, requiredNetworkBandwidth) -&gt; requiredNetworkBandwidth - computer.getNetworkBandwidth());
    }

    Constraint computerCost(ConstraintFactory constraintFactory) {
        return constraintFactory.forEach(CloudComputer.class)
                .ifExists(CloudProcess.class, equal(Function.identity(), CloudProcess::getComputer))
                .penalize("computerCost",
                        HardSoftScore.ONE_SOFT,
                        CloudComputer::getCost);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You may have noticed similarities between <a href="../../constraint-streams/constraint-streams.html#constraintStreams" class="page">Constraint Streams</a> and <a href="../../drools-score-calculation/drools-score-calculation.html#droolsScoreCalculation" class="page">Drools score calculation</a>.
That is no coincidence, as Constraint Streams are implemented using Drools under the hood.</p>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingIncrementalJavaScoreConfiguration"><a class="anchor" href="#cloudBalancingIncrementalJavaScoreConfiguration"></a>Incremental Java score configuration</h3>
<div class="paragraph">
<p>Another way to define a score function is to implement the interface <code>IncrementalScoreCalculator</code> in plain Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingIncrementalScoreCalculator&lt;/easyScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 8. CloudBalancingIncrementalScoreCalculator.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class CloudBalancingIncrementalScoreCalculator
        implements IncrementalScoreCalculator&lt;CloudBalance, HardSoftScore&gt; {

    private Map&lt;CloudComputer, Integer&gt; cpuPowerUsageMap;
    private Map&lt;CloudComputer, Integer&gt; memoryUsageMap;
    private Map&lt;CloudComputer, Integer&gt; networkBandwidthUsageMap;
    private Map&lt;CloudComputer, Integer&gt; processCountMap;

    private int hardScore;
    private int softScore;

    @Override
    public void resetWorkingSolution(CloudBalance cloudBalance) {
        int computerListSize = cloudBalance.getComputerList().size();
        cpuPowerUsageMap = new HashMap&lt;&gt;(computerListSize);
        memoryUsageMap = new HashMap&lt;&gt;(computerListSize);
        networkBandwidthUsageMap = new HashMap&lt;&gt;(computerListSize);
        processCountMap = new HashMap&lt;&gt;(computerListSize);
        for (CloudComputer computer : cloudBalance.getComputerList()) {
            cpuPowerUsageMap.put(computer, 0);
            memoryUsageMap.put(computer, 0);
            networkBandwidthUsageMap.put(computer, 0);
            processCountMap.put(computer, 0);
        }
        hardScore = 0;
        softScore = 0;
        for (CloudProcess process : cloudBalance.getProcessList()) {
            insert(process);
        }
    }

    @Override
    public void beforeVariableChanged(Object entity, String variableName) {
        retract((CloudProcess) entity);
    }

    @Override
    public void afterVariableChanged(Object entity, String variableName) {
        insert((CloudProcess) entity);
    }

    @Override
    public void beforeEntityRemoved(Object entity) {
        retract((CloudProcess) entity);
    }

    ...

    private void insert(CloudProcess process) {
        CloudComputer computer = process.getComputer();
        if (computer != null) {
            int cpuPower = computer.getCpuPower();
            int oldCpuPowerUsage = cpuPowerUsageMap.get(computer);
            int oldCpuPowerAvailable = cpuPower - oldCpuPowerUsage;
            int newCpuPowerUsage = oldCpuPowerUsage + process.getRequiredCpuPower();
            int newCpuPowerAvailable = cpuPower - newCpuPowerUsage;
            hardScore += Math.min(newCpuPowerAvailable, 0) - Math.min(oldCpuPowerAvailable, 0);
            cpuPowerUsageMap.put(computer, newCpuPowerUsage);

            int memory = computer.getMemory();
            int oldMemoryUsage = memoryUsageMap.get(computer);
            int oldMemoryAvailable = memory - oldMemoryUsage;
            int newMemoryUsage = oldMemoryUsage + process.getRequiredMemory();
            int newMemoryAvailable = memory - newMemoryUsage;
            hardScore += Math.min(newMemoryAvailable, 0) - Math.min(oldMemoryAvailable, 0);
            memoryUsageMap.put(computer, newMemoryUsage);

            int networkBandwidth = computer.getNetworkBandwidth();
            int oldNetworkBandwidthUsage = networkBandwidthUsageMap.get(computer);
            int oldNetworkBandwidthAvailable = networkBandwidth - oldNetworkBandwidthUsage;
            int newNetworkBandwidthUsage = oldNetworkBandwidthUsage + process.getRequiredNetworkBandwidth();
            int newNetworkBandwidthAvailable = networkBandwidth - newNetworkBandwidthUsage;
            hardScore += Math.min(newNetworkBandwidthAvailable, 0) - Math.min(oldNetworkBandwidthAvailable, 0);
            networkBandwidthUsageMap.put(computer, newNetworkBandwidthUsage);

            int oldProcessCount = processCountMap.get(computer);
            if (oldProcessCount == 0) {
                softScore -= computer.getCost();
            }
            int newProcessCount = oldProcessCount + 1;
            processCountMap.put(computer, newProcessCount);
        }
    }

    private void retract(CloudProcess process) {
        CloudComputer computer = process.getComputer();
        if (computer != null) {
            int cpuPower = computer.getCpuPower();
            int oldCpuPowerUsage = cpuPowerUsageMap.get(computer);
            int oldCpuPowerAvailable = cpuPower - oldCpuPowerUsage;
            int newCpuPowerUsage = oldCpuPowerUsage - process.getRequiredCpuPower();
            int newCpuPowerAvailable = cpuPower - newCpuPowerUsage;
            hardScore += Math.min(newCpuPowerAvailable, 0) - Math.min(oldCpuPowerAvailable, 0);
            cpuPowerUsageMap.put(computer, newCpuPowerUsage);

            int memory = computer.getMemory();
            int oldMemoryUsage = memoryUsageMap.get(computer);
            int oldMemoryAvailable = memory - oldMemoryUsage;
            int newMemoryUsage = oldMemoryUsage - process.getRequiredMemory();
            int newMemoryAvailable = memory - newMemoryUsage;
            hardScore += Math.min(newMemoryAvailable, 0) - Math.min(oldMemoryAvailable, 0);
            memoryUsageMap.put(computer, newMemoryUsage);

            int networkBandwidth = computer.getNetworkBandwidth();
            int oldNetworkBandwidthUsage = networkBandwidthUsageMap.get(computer);
            int oldNetworkBandwidthAvailable = networkBandwidth - oldNetworkBandwidthUsage;
            int newNetworkBandwidthUsage = oldNetworkBandwidthUsage - process.getRequiredNetworkBandwidth();
            int newNetworkBandwidthAvailable = networkBandwidth - newNetworkBandwidthUsage;
            hardScore += Math.min(newNetworkBandwidthAvailable, 0) - Math.min(oldNetworkBandwidthAvailable, 0);
            networkBandwidthUsageMap.put(computer, newNetworkBandwidthUsage);

            int oldProcessCount = processCountMap.get(computer);
            int newProcessCount = oldProcessCount - 1;
            if (newProcessCount == 0) {
                softScore += computer.getCost();
            }
            processCountMap.put(computer, newProcessCount);
        }
    }

    @Override
    public HardSoftScore calculateScore() {
        return HardSoftScore.of(hardScore, softScore);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This score calculation is the fastest we can possibly make it.
It reacts to every planning variable change, making the smallest possible adjustment to the score.</p>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancingDroolsScoreConfiguration"><a class="anchor" href="#cloudBalancingDroolsScoreConfiguration"></a>Drools score configuration</h3>
<div class="paragraph">
<p>Drools score calculation uses incremental calculation.
Each score constraint is written as one or more score rules.</p>
</div>
<div class="paragraph">
<p><strong>Prerequisite</strong>
To use the Drools rule engine as a score function, simply add a <code>scoreDrl</code> resource in the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/cloudbalancing/optional/score/cloudBalancingConstraints.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We want to make sure that all computers have enough CPU, RAM and network bandwidth to support all their processes, so we make these hard constraints:</p>
<div class="exampleblock">
<div class="title">Example 9. cloudBalancingConstraints.drl - Hard Constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>...

import org.optaplanner.examples.cloudbalancing.domain.CloudBalance;
import org.optaplanner.examples.cloudbalancing.domain.CloudComputer;
import org.optaplanner.examples.cloudbalancing.domain.CloudProcess;

global HardSoftScoreHolder scoreHolder;

// ############################################################################
// Hard constraints
// ############################################################################

rule "requiredCpuPowerTotal"
    when
        $computer : CloudComputer($cpuPower : cpuPower)
        accumulate(
            CloudProcess(
                computer == $computer,
                $requiredCpuPower : requiredCpuPower);
            $requiredCpuPowerTotal : sum($requiredCpuPower);
            $requiredCpuPowerTotal &gt; $cpuPower
        )
    then
        scoreHolder.addHardConstraintMatch(kcontext, $cpuPower - $requiredCpuPowerTotal);
end

rule "requiredMemoryTotal"
    ...
end

rule "requiredNetworkBandwidthTotal"
    ...
end</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>If those constraints are met, we want to minimize the maintenance cost, so we add that as a soft constraint:</p>
<div class="exampleblock">
<div class="title">Example 10. cloudBalancingConstraints.drl - Soft Constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>// ############################################################################
// Soft constraints
// ############################################################################

rule "computerCost"
    when
        $computer : CloudComputer($cost : cost)
        exists CloudProcess(computer == $computer)
    then
        scoreHolder.addSoftConstraintMatch(kcontext, - $cost);
end</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloudBalancingBeyondThisTutorial"><a class="anchor" href="#cloudBalancingBeyondThisTutorial"></a>Beyond this tutorial</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that this simple example works, you can try going further.
For example, you can enrich the domain model and add extra constraints such as these:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each <code>Process</code> belongs to a <code>Service</code>. A computer might crash, so processes running the same service must be assigned to different computers.</p>
</li>
<li>
<p>Each <code>Computer</code> is located in a <code>Building</code>. A building might burn down, so processes of the same services should (or must) be assigned to computers in different buildings.</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script src="../../../../_/js/vendor/lunr-2.3.9.min.js"></script>
<script src="../../../../_/js/vendor/search.js" id="search-script" data-base-path="../../../.." data-page-path="/optaplanner/latest/use-cases-and-examples/cloud-balancing/cloud-balancing.html"></script>
<script async src="../../../../_/../search-index.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>

<!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 2/2 -->
<script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
</script>  </body>
</html>
